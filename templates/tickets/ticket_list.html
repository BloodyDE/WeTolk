{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}üìÇ Alle Knowledges ‚Äì Knowledge Base{% endblock title %}

{% block extra_css %}
<style>
  /* Akkordeon: aus/ein */
  [data-toggle="collapse"][aria-expanded="false"] + ul { display: none; }

  /* Layout: links Akkordeon (scrollbar), rechts Detail */
  .kb-grid{
    display:grid;
    grid-template-columns: 1fr;       /* mobil: untereinander */
    gap: 1.5rem;
    align-items:start;
  }
  @media (min-width:1024px){
    .kb-grid{ grid-template-columns: 1fr 2fr; }
    .kb-sidebar{
      position: sticky;
      top: 7rem;                       /* ggf. an Navbarh√∂he anpassen */
      max-height: calc(100vh - 8rem);  /* passt unter die Navbar */
      overflow: auto;                  /* eigene Scrollbar links */
    }
  }
</style>
  {{ block.super }}
  <style>
    /* Kommentare als klare Karten ‚Äì auf das Snippet gescoped */
    .ticket-snippet .comments-list{ list-style:none; padding:0; margin:0; display:grid; gap:1rem; }
    .ticket-snippet .comment-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-left:4px solid #6366f1;
      border-radius:1rem;
      padding:1rem 1.1rem;
      box-shadow:0 10px 24px -14px rgba(2,6,23,.28);
    }
    .ticket-snippet .comment-header{ display:flex; align-items:center; gap:.45rem; margin-bottom:.4rem; }
    .ticket-snippet .comment-author{ font-weight:600; color:#111827; }
    .ticket-snippet .comment-time{ font-size:.85rem; color:#6b7280; }
    .ticket-snippet .comment-body{ color:#374151; white-space:pre-wrap; }

    /* Kommentarformular h√ºbsch & konsistent */
    .ticket-snippet .comment-form .row{ margin-bottom:1rem; }
    .ticket-snippet .comment-form input[type="text"],
    .ticket-snippet .comment-form textarea{
      width:100%; background:#fff;
      border:1px solid #e5e7eb; border-radius:.75rem;
      padding:.75rem .9rem; color:#111827;
      box-shadow:0 4px 14px -6px rgba(2,6,23,.08);
    }
    .ticket-snippet .comment-form input::placeholder,
    .ticket-snippet .comment-form textarea::placeholder{ color:#9ca3af; }
    .ticket-snippet .comment-form input:focus,
    .ticket-snippet .comment-form textarea:focus{
      outline:none; border-color:#818cf8;
      box-shadow:0 0 0 3px rgba(99,102,241,.20);
    }

    /* Prim√§rer ‚ÄûSenden‚Äú-Button im Seitenstil */
    .ticket-snippet .comment-form .btn-primary{
      display:inline-flex; align-items:center; justify-content:center;
      gap:.5rem; cursor:pointer; border:0; border-radius:.9rem;
      padding:.7rem 1.1rem; font-weight:700; color:#fff;
      background:linear-gradient(90deg,#6366f1,#22d3ee,#10b981);
      background-size:200% 100%;
      box-shadow:0 12px 30px -12px rgba(16,24,40,.35);
      transition:transform .12s ease, box-shadow .2s ease, background-position .35s ease, filter .2s ease;
    }
    .ticket-snippet .comment-form .btn-primary:hover{ transform:translateY(-1px); background-position:100% 0; }
    .ticket-snippet .comment-form .btn-primary:active{ transform:translateY(0); filter:brightness(.98); }
    .ticket-snippet .comment-form .btn-primary:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(99,102,241,.35); }
  </style>

  <style>
  /* Mehr Luft im 2-Spalten-Layout */
  .kb-grid{ row-gap: 2rem; }                  /* vertikale L√ºcke Grid */

  /* Sidebar: sanfter vertikaler Rhythmus */
  .kb-sidebar > ul > li + li{ margin-top:.6rem; }
  .kb-sidebar ul ul{ margin-top:.35rem; }     /* subcat/ticket-Liste startet mit Abstand */
  .kb-sidebar ul ul > li + li{ margin-top:.3rem; }
  .kb-sidebar .ticket-link{ border-radius:.5rem; }

  /* Detailpane/Snippet: einheitliche Abst√§nde zwischen Bl√∂cken */
  .ticket-snippet > * + *{ margin-top:1rem; } /* Abstand zwischen direkten Kindern */
  .ticket-snippet dl > div + div{ margin-top:.5rem; }
  .ticket-snippet h3{ margin-top:.5rem; }

  /* Kommentare: oben etwas Luft und gleichm√§√üige Karten-Abst√§nde */
  .ticket-snippet .comments-list{ margin-top:1rem; }
  .ticket-snippet .comment-card + .comment-card{ margin-top:.75rem; }

 /* Sichtbare Ticket-Links in der linken Sidebar */
  .kb-sidebar .ticket-link{
    color:#111827 !important;        /* gray-900 */
    font-size:0.9375rem;             /* ~ text-sm */
    line-height:1.25rem;
  }
  .kb-sidebar .ticket-link .text-gray-500{
    color:#6b7280 !important;        /* gray-500 f√ºr Datum */
  }
  /* Optional: dezenter Marker */
  .kb-sidebar ul.list-disc > li::marker{
    color:#9ca3af;                    /* gray-400 */
  }

    /* Such-Button klar klickbar machen */
  .search-form .search-btn{
    cursor:pointer; pointer-events:auto;
    display:inline-flex; align-items:center; justify-content:center;
    min-width:2.75rem; min-height:2.75rem;   /* gro√üer Hit-Bereich */
    border:0; border-radius:0 .5rem .5rem 0;
    color:#fff;
    background:linear-gradient(90deg,#6366f1,#22d3ee,#10b981);
    background-size:200% 100%;
    box-shadow:0 8px 20px -8px rgba(16,24,40,.25);
    transition:transform .12s ease, box-shadow .2s ease, background-position .35s ease, filter .2s ease;
  }
  .search-form .search-btn:hover{
    background-position:100% 0;
    transform:translateY(-1px);
  }
  .search-form .search-btn:active{
    transform:translateY(0);
    filter:brightness(.97);
  }
  .search-form .search-btn:focus-visible{
    outline:none;
    box-shadow:0 0 0 3px rgba(99,102,241,.35);
  }
  .search-form .search-btn svg{
    width:18px; height:18px; stroke:currentColor;
  }

</style>

{% endblock extra_css %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
  <!-- Kopfzeile -->
  <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
    <h1 class="text-2xl font-bold tracking-tight text-indigo-800">Alle Knowledges</h1>

    <div class="flex items-center gap-4">
      <form method="get" action="{% url 'tickets:ticket_list' %}"
      class="search-form flex bg-white/70 backdrop-blur rounded-lg shadow ring-1 ring-black/5 overflow-hidden">

  <input id="q" type="text" name="q" value="{{ query }}"
         placeholder="Titel oder Schlagwort‚Ä¶"
         class="px-4 py-2 flex-1 bg-transparent focus:outline-none focus:ring-2 focus:ring-indigo-200" />

  <button type="submit" class="search-btn" aria-label="Suchen" title="Suchen">
    <!-- Lupe (SVG) -->
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
      <circle cx="11" cy="11" r="7" stroke-width="2" />
      <path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</form>

      <nav class="space-x-2 text-sm text-indigo-700">
        <span class="text-gray-600">Sortieren:</span>
        <a href="{% url 'tickets:ticket_list' %}?sort=asc{% if query %}&q={{ query|urlencode }}{% endif %}"
   class="underline hover:no-underline{% if sort == 'asc' %} font-semibold{% endif %}">√Ñlteste zuerst</a>

<span class="text-gray-400">|</span>

<a href="{% url 'tickets:ticket_list' %}?sort=desc{% if query %}&q={{ query|urlencode }}{% endif %}"
   class="underline hover:no-underline{% if sort == 'desc' %} font-semibold{% endif %}">Neueste zuerst</a>
      </nav>
    </div>
  </div>

  <!-- 2-Spalten-Layout -->
<div class="kb-grid">
  <!-- LINKS: Kategorien/Accordion, hat eigene Scrollbar -->
  <aside class="kb-sidebar bg-white/70 backdrop-blur rounded-2xl shadow-xl border border-white/40 p-4 lg:p-6">
    <h2 class="text-lg lg:text-xl font-bold text-indigo-700 flex items-center gap-2 mb-3">
      <span>üóÇÔ∏è</span> Kategorien
    </h2>

    {% if ticket_tree %}
      <ul class="space-y-2">
        {% for category, subcats in ticket_tree.items %}
          <li class="rounded-lg">
            <button type="button"
              class="w-full text-left text-teal-700 font-medium px-3 py-2 hover:bg-indigo-50 rounded flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-indigo-200"
              data-toggle="collapse"
              data-target="#cat-{{ forloop.counter }}"
              aria-controls="cat-{{ forloop.counter }}"
              aria-expanded="true">
              <span class="truncate">{{ category }}</span>
              <svg class="h-5 w-5 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>

            <ul id="cat-{{ forloop.counter }}" class="ml-3 mt-2 space-y-2">
              {% for subcat, tickets in subcats.items %}
                <li>
                  <button type="button"
                    class="w-full text-left text-indigo-700 font-medium px-3 py-1.5 hover:bg-indigo-50 rounded flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-indigo-200"
                    data-toggle="collapse"
                    data-target="#subcat-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                    aria-controls="subcat-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                    aria-expanded="true">
                    <span class="truncate">{{ subcat }}</span>
                    <svg class="h-4 w-4 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                  </button>

                  <ul id="subcat-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="ml-4 list-disc list-outside space-y-1">
                    {% for ticket in tickets %}
                      <li>
                        <a href="{% url 'tickets:ticket_detail' ticket.pk %}"
                              hx-get="{% url 'tickets:ticket_snippet' ticket.pk %}"
                              hx-target="#detail-pane"
                              hx-swap="innerHTML"
                              hx-push-url="{% url 'tickets:ticket_list' %}?open={{ ticket.pk }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                              hx-indicator="#pane-loading"
                              class="ticket-link block px-3 py-2 rounded hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-200 truncate">
                              <span class="font-medium">{{ ticket.title }}</span>
                              <span class="text-gray-500 text-sm"> ({{ ticket.created_at|date:"d.m.Y H:i" }})</span>
                            </a>
                      </li>
                    {% endfor %}
                  </ul>
                </li>
              {% endfor %}
            </ul>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-600 italic">Keine Kategorien/Tickets gefunden.</p>
    {% endif %}
  </aside>

  <!-- RECHTS: Detailansicht -->
<section id="detail-pane"
         class="bg-white/70 backdrop-blur rounded-2xl shadow-xl border border-white/40 p-4 lg:p-8"
         hx-history-elt
         {% if open_id %} hx-get="{% url 'tickets:ticket_snippet' open_id %}" hx-trigger="load" {% endif %}>
  <div id="pane-loading" class="hidden text-gray-500 italic mb-4">L√§dt‚Ä¶</div>
  <div class="min-h-[24rem] flex items-center justify-center italic text-gray-500 text-center px-6">
    W√§hle links ein Knowledge aus‚Ä¶ üß†
  </div>
</section>
{% endblock content %}

{% block extra_js %}
<script>
(function(){
  function initAccordion(root){
    (root || document).querySelectorAll('[data-toggle="collapse"]').forEach((btn) => {
      if (btn.dataset.bound === '1') return;
      btn.dataset.bound = '1';
      const icon = btn.querySelector('svg');

      if (!btn.hasAttribute('aria-expanded')) {
        btn.setAttribute('aria-expanded', 'true');
        if (icon) icon.classList.add('rotate-180');
      }

      btn.addEventListener('click', () => {
        const open = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', open ? 'false' : 'true');
        if (icon) icon.classList.toggle('rotate-180');
      });
    });
  }

  function initHighlight(){
    const nav = document.querySelector('aside');
    if (!nav || nav.dataset.bound === '1') return;
    nav.dataset.bound = '1';
    nav.addEventListener('click', (e) => {
      const link = e.target.closest('.ticket-link');
      if (!link) return;
      nav.querySelectorAll('.ticket-link').forEach((l) =>
        l.classList.remove('bg-indigo-100','font-semibold','border-l-4','border-indigo-500')
      );
      link.classList.add('bg-indigo-100','font-semibold','border-l-4','border-indigo-500');
    });
  }

  window.addEventListener('DOMContentLoaded', () => {
    initAccordion(document);
    initHighlight();
  });

  window.addEventListener('pageshow', () => { // bfcache
    initAccordion(document);
    initHighlight();
  });

  document.body.addEventListener('htmx:afterSwap', (e) => {
    initAccordion(e.target);
    initHighlight();
  });
})();
</script>

{% endblock extra_js %}
