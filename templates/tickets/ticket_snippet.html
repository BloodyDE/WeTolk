{% load widget_tweaks %}

{# templates/tickets/ticket_snippet.html #}
<div id="snippet-container-{{ ticket.pk }}">

  <div class="p-4 bg-white rounded shadow mb-4">
    <h2 class="text-2xl font-bold text-indigo-700 mb-2">{{ ticket.title }}</h2>
    <p class="text-sm text-gray-600">{{ ticket.creator_name }} • {{ ticket.created_at|date:"d.m.Y H:i" }}</p>
    <dl class="mt-4 space-y-3">
      <div><dt class="font-semibold">Kategorie:</dt><dd>{{ ticket.category }} → {{ ticket.subcategory }}</dd></div>
      <div><dt class="font-semibold">Projekt:</dt><dd>{{ ticket.project }} ({{ ticket.project_type }})</dd></div>
      {% if ticket.tag_list %}
      <div><dt class="font-semibold">🏷️ Schlagworte:</dt><dd class="flex flex-wrap gap-2">
        {% for tag in ticket.tag_list %}
          <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded mr-1">{{ tag }}</span>
        {% endfor %}
      </dd></div>
      {% endif %}
    </dl>

    <div class="mt-4">
      <h3 class="font-semibold text-gray-800 mb-1">📋 Beschreibung</h3>
      <p class="whitespace-pre-wrap text-gray-700">{{ ticket.description }}</p>
    </div>

    {% if ticket.solution %}
    <div class="mt-4">
      <h3 class="font-semibold text-gray-800 mb-1">💡 Lösung</h3>
      <p class="whitespace-pre-wrap text-gray-700">{{ ticket.solution }}</p>
    </div>
    {% endif %}

    {% if ticket.impact %}
    <div class="mt-4">
      <h3 class="font-semibold text-gray-800 mb-1">⚡ Auswirkungen</h3>
      <p class="whitespace-pre-wrap text-gray-700">{{ ticket.impact }}</p>
    </div>
    {% endif %}

    {% if ticket.attachment %}
    <div class="mt-4">
      <h3 class="font-semibold text-gray-800 mb-1">📎 Anhang</h3>
      <a href="{{ ticket.attachment.url }}" download class="text-indigo-600 hover:underline">
        {{ ticket.attachment.name|cut:"attachments/" }}
      </a>
    </div>
    {% endif %}
  </div>

  {# Kommentare auflisten #}
  <ul class="space-y-4 mb-6">
    {% for c in ticket.comments.all %}
      <li class="p-4 bg-gray-50 rounded">
        <p class="text-sm text-gray-600">{{ c.author_name }} • {{ c.created_at|date:"d.m.Y H:i" }}</p>
        <p class="mt-2 whitespace-pre-wrap">{{ c.message }}</p>
      </li>
    {% empty %}
      <li class="italic text-gray-500">Bisher keine Kommentare.</li>
    {% endfor %}
  </ul>

  {# Neues Kommentar-Formular #}
  <h3 class="text-xl font-semibold mb-2">Neuen Kommentar hinzufügen</h3>
  <form
    method="post"
    hx-post="{% url 'tickets:ticket_snippet' ticket.pk %}"
    hx-target="#snippet-container-{{ ticket.pk }}"
    hx-swap="outerHTML"
    class="space-y-4"
  >
    {% csrf_token %}

    <div>
      {{ comment_form.author_name.label_tag }}
      {{ comment_form.author_name|add_class:"w-full p-2 border rounded focus:ring-2 focus:ring-indigo-200" }}
      {{ comment_form.author_name.errors }}
    </div>

    <div>
      {{ comment_form.message.label_tag }}
      {{ comment_form.message|add_class:"w-full p-2 border rounded focus:ring-2 focus:ring-indigo-200" }}
      {{ comment_form.message.errors }}
    </div>

    <button type="submit" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 transition">
      Senden
    </button>
  </form>

</div>
