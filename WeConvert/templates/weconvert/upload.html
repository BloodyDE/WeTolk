{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}WeConvert ‚Äì Bild zu PNG{% endblock %}

{% block extra_css %}
<style>
  /* --- Layout etc. (deins, unver√§ndert au√üer sauber geschlossen) --- */
  .wc-wrap{ display:flex; justify-content:center; padding:1.25rem 0; }
  .wc-card{ width:100%; max-width:28rem; margin:0 auto; background:#fff; border:1px solid rgba(255,255,255,.6);
            border-radius:1rem; padding:1.25rem; box-shadow:0 18px 40px -18px rgba(2,6,23,.22); }
  @media (min-width:640px){ .wc-card{ padding:1.75rem; margin-top:1.25rem; } }
  .wc-title{ font-size:1.4rem; font-weight:800; color:#4338ca; text-align:center; letter-spacing:.2px; margin:.25rem 0 1.25rem; }
  .wc-drop{ position:relative; border:1px dashed #c7d2fe; background:linear-gradient(180deg,#ffffff,#f8fafc);
            border-radius:.9rem; padding:1rem; transition:box-shadow .2s ease,transform .12s ease,border-color .2s ease; }
  .wc-drop.is-dragover{ border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.20); }
  .wc-input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
  .wc-drop-inner{ display:flex; align-items:center; gap:.75rem; }
  .wc-filebtn{ display:inline-flex; align-items:center; gap:.5rem; cursor:pointer; border:0; border-radius:.7rem; padding:.55rem .9rem;
               font-weight:700; color:#fff; background:linear-gradient(90deg,#6366f1,#22d3ee,#10b981); background-size:200% 100%;
               box-shadow:0 10px 24px -12px rgba(16,24,40,.28); transition:transform .12s ease,box-shadow .2s ease,background-position .35s ease,filter .2s ease; }
  .wc-filebtn:hover{ transform:translateY(-1px); background-position:100% 0; }
  .wc-filebtn:active{ transform:translateY(0); filter:brightness(.98); }
  .wc-name{ color:#374151; font-size:.925rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .wc-actions{ margin-top:1rem; }
  .primary-submit{ width:100%; display:inline-flex; justify-content:center; align-items:center; gap:.6rem; border:0; border-radius:.9rem; padding:.8rem 1rem;
                   font-weight:800; color:#fff; background:linear-gradient(90deg,#6366f1,#22d3ee,#10b981); background-size:200% 100%;
                   box-shadow:0 16px 36px -16px rgba(16,24,40,.35); transition:transform .12s ease, box-shadow .2s ease, background-position .35s ease, filter .2s ease; }
  .primary-submit:hover{ transform:translateY(-1px); background-position:100% 0; }
  .primary-submit:active{ transform:translateY(0); filter:brightness(.98); }
  .is-busy .primary-submit{ opacity:.9; cursor:wait; }
  .spinner{ width:1.05rem; height:1.05rem; border-radius:9999px; border:2px solid rgba(255,255,255,.55); border-top-color:#fff; animation:spin .9s linear infinite; display:none; }
  .is-busy .spinner{ display:inline-block; }
  @keyframes spin{ to{ transform: rotate(360deg); } }
  .wc-label{ font-weight:600; color:#334155; margin-bottom:.5rem; display:block; }
  .primary-submit{ cursor:pointer; } .primary-submit[disabled]{ cursor:not-allowed; }
</style>

<style>
  /* --- Slider STYLES (blau + animierte F√ºllung) --- */
  :root{ --wc-blue:#6366f1; --wc-track:#e5e7eb; }

  #id_quality{
    -webkit-appearance:none; appearance:none; width:100%; height:.75rem; border-radius:9999px; outline:none;
    background:linear-gradient(to right,
      var(--wc-blue) 0%,
      var(--wc-blue) var(--wc-val,50%),
      var(--wc-track) var(--wc-val,50%),
      var(--wc-track) 100%
    );
    transition:box-shadow .2s ease, background-position .2s ease;
    accent-color:var(--wc-blue);
  }
  #id_quality:focus-visible{ box-shadow:0 0 0 4px rgba(99,102,241,.2); }

  /* Chrome/Edge/Safari */
  #id_quality::-webkit-slider-runnable-track{ height:.75rem; background:transparent; border-radius:9999px; }
  #id_quality::-webkit-slider-thumb{
    -webkit-appearance:none; width:20px; height:20px; border-radius:9999px;
    background:var(--wc-blue); border:3px solid #fff;
    box-shadow:0 6px 16px rgba(79,70,229,.35);
    transition:transform .12s ease, box-shadow .2s ease, background-color .2s ease;
    margin-top:-6px;
  }
  #id_quality:hover::-webkit-slider-thumb{ transform:scale(1.06); }
  #id_quality:active::-webkit-slider-thumb{ transform:scale(1.14); box-shadow:0 8px 22px rgba(79,70,229,.45); }

  /* Firefox */
  #id_quality::-moz-range-track{ height:.75rem; background:var(--wc-track); border-radius:9999px; }
  #id_quality::-moz-range-progress{ height:.75rem; background:var(--wc-blue); border-radius:9999px; }
  #id_quality::-moz-range-thumb{
    width:20px; height:20px; border:3px solid #fff; border-radius:9999px; background:var(--wc-blue);
    box-shadow:0 6px 16px rgba(79,70,229,.35);
    transition:transform .12s ease, box-shadow .2s ease, background-color .2s ease;
  }
  #id_quality:hover::-moz-range-thumb{ transform:scale(1.06); }
  #id_quality:active::-moz-range-thumb{ transform:scale(1.14); box-shadow:0 8px 22px rgba(79,70,229,.45); }
  #row-progressive, #help-progressive,
#row-lossless-webp, #help-lossless { display: none; }
</style>
{% endblock extra_css %}


{% block content %}
<div class="wc-wrap">
  <div class="wc-card">
    <h1 class="wc-title">WeConvert: Bild konvertieren &amp; komprimieren</h1>

    {# EINZIGES Formular #}
    <form id="wc-form" method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      {{ form.non_field_errors }}

      {# --- Datei-Upload (Dropzone) --- #}
      <label class="wc-label" for="id_image">W√§hle dein Bild:</label>
      <div id="wc-drop" class="wc-drop">
        {{ form.image|add_class:"wc-input"|attr:"accept:image/*" }}
        <div class="wc-drop-inner">
          <button type="button" class="wc-filebtn" onclick="document.getElementById('id_image').click()">
            üìé Datei ausw√§hlen
          </button>
          <div id="wc-file-name" class="wc-name">Keine Datei ausgew√§hlt</div>
        </div>
      </div>
      {{ form.image.errors }}

      {# --- Zielformat --- #}
      <label class="wc-label" for="{{ form.out_format.id_for_label }}">Zielformat</label>
      {{ form.out_format|add_class:"w-full p-2 border rounded" }}
      {{ form.out_format.errors }}

      {# --- Qualit√§t (Slider) --- #}
      <div class="flex items-center justify-between" style="margin-top:.75rem;">
        <label class="wc-label" for="{{ form.quality.id_for_label }}" style="margin:0;">Qualit√§t</label>
        <span id="qval" class="text-sm text-gray-600"></span>
      </div>
      {{ form.quality|add_class:"w-full" }}
      {{ form.quality.errors }}
      <p class="text-sm text-gray-500 mt-1">
        H√∂her = bessere Qualit√§t, gr√∂√üere Datei.</p>

      {# --- Format-spezifische Optionen --- #}
      <div class="space-y-2" style="margin-top:.5rem;">
  <label id="row-progressive" class="flex items-center gap-2">
    {{ form.progressive }}
    <span>Progressives JPEG (schnellerer Seitenaufbau)</span>
  </label>
  <p id="help-progressive" class="text-sm text-gray-500 -mt-1">
    Das Bild wird in mehreren Durchg√§ngen geladen: erst grob, dann immer sch√§rfer.
    Gut f√ºr Webseiten und langsame Verbindungen. Bildqualit√§t bleibt gleich.
  </p>

  <label id="row-lossless-webp" class="flex items-center gap-2">
    {{ form.lossless_webp }}
    <span>WebP verlustfrei (keine Qualit√§tsverluste)</span>
  </label>
  <p id="help-lossless" class="text-sm text-gray-500 -mt-1">
    Speichert ohne Qualit√§tsverlust. Dateien sind oft gr√∂√üer als ‚ÄûWebP (verlustbehaftet)‚Äú,
    aber h√§ufig kleiner als PNG. Ideal, wenn 100 % Qualit√§t wichtig ist.
  </p>
</div>



      {# --- Absenden --- #}
      <div class="wc-actions">
        <button id="wc-submit" type="submit" class="primary-submit">
          <span class="spinner" aria-hidden="true"></span>
          Konvertieren &amp; Download
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
(function(){
  /* ------------------ SLIDER (F√ºllung + Zahl) ------------------ */
  const range = document.getElementById('id_quality');
  const out   = document.getElementById('qval');

  function updateQualityUI(){
    if (!range) return;
    const min = parseFloat(range.min) || 1;
    const max = parseFloat(range.max) || 100;
    const val = parseFloat(range.value || min);
    const pct = ((val - min) * 100) / (max - min);
    range.style.setProperty('--wc-val', pct + '%'); // blaue F√ºllung
    if (!range.disabled && out) out.textContent = String(Math.round(val));
  }

  /* --------- Checkbox-Zeilen je nach Zielformat ein/aus -------- */
  const rowProg  = document.getElementById('row-progressive');
  const helpProg = document.getElementById('help-progressive');
  const rowLoss  = document.getElementById('row-lossless-webp');
  const helpLoss = document.getElementById('help-lossless');
  const cbLoss   = document.querySelector('input[name="lossless_webp"]') || document.getElementById('id_lossless_webp');

  function getFmtValue(){
    const sel = document.querySelector('select[name="out_format"]');
    if (sel) return String(sel.value || '').toUpperCase();
    const checked = document.querySelector('input[name="out_format"]:checked');
    if (checked) return String(checked.value || '').toUpperCase();
    const byId = document.getElementById('id_out_format');
    if (byId) return String(byId.value || '').toUpperCase();
    return '';
  }

  function show(el, on){
    if (!el) return;
    el.style.display = on ? (el.tagName === 'LABEL' ? 'flex' : 'block') : 'none';
  }

  function toggleRows(){
    const v = getFmtValue();            // z.B. "JPEG", "JPG", "WEBP", "image/webp"
    const isJpeg = /JPE?G/.test(v);
    const isWebp = v.includes('WEBP');
    show(rowProg,  isJpeg);  show(helpProg, isJpeg);
    show(rowLoss,  isWebp);  show(helpLoss, isWebp);
  }

  /* ---- Qualit√§ts-Slider deaktivieren, wenn WebP verlustfrei ---- */
  function updateQualityDisabled(){
    const isWebp = getFmtValue().includes('WEBP');
    const lossOn = !!(cbLoss && cbLoss.checked);
    const disable = isWebp && lossOn;
    if (range){
      range.disabled = disable;
      range.style.opacity = disable ? '0.5' : '';
      if (out) out.textContent = disable ? 'verlustfrei' : out.textContent;
    }
    if (!disable) updateQualityUI();
  }

  // Events binden
  document.querySelectorAll('select[name="out_format"], input[name="out_format"]').forEach(el=>{
    el.addEventListener('change', ()=>{
      toggleRows();
      updateQualityDisabled();
    });
  });
  if (cbLoss){
    cbLoss.addEventListener('change', updateQualityDisabled);
  }
  if (range){
    range.addEventListener('input', updateQualityUI);
  }

  // Initial
  toggleRows();
  updateQualityDisabled();
  updateQualityUI();
})();
</script>
{% endblock extra_js %}